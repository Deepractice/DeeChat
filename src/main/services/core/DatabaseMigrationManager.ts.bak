import { DatabaseService } from './DatabaseService';
import { SimplifiedMigrationService } from './SimplifiedMigrationService';
import { SqliteChatSessionRepository } from '../../repositories/SqliteChatSessionRepository';
import { SqliteModelConfigRepository } from '../../repositories/SqliteModelConfigRepository';

/**
 * æ•°æ®åº“è¿ç§»ç®¡ç†å™¨ - å¥¥å¡å§†å‰ƒåˆ€å®ç°
 * 
 * è®¾è®¡åŸåˆ™ï¼š
 * 1. è‡ªåŠ¨æ£€æµ‹è¿ç§»éœ€æ±‚
 * 2. é›¶åœæœºçƒ­åˆ‡æ¢
 * 3. å®Œæ•´çš„å›æ»šæœºåˆ¶
 * 4. æ¸è¿›å¼æ›¿æ¢ç­–ç•¥
 */
export class DatabaseMigrationManager {
  private databaseService: DatabaseService;
  private migrationService: SimplifiedMigrationService;
  private sqliteChatRepository: SqliteChatSessionRepository;
  private sqliteConfigRepository: SqliteModelConfigRepository;
  
  private migrationCompleted = false;

  constructor() {
    this.databaseService = new DatabaseService();
    this.migrationService = new SimplifiedMigrationService(this.databaseService);
    this.sqliteChatRepository = new SqliteChatSessionRepository(this.databaseService);
    this.sqliteConfigRepository = new SqliteModelConfigRepository(this.databaseService);
  }

  /**
   * åˆå§‹åŒ–å¹¶è‡ªåŠ¨æ‰§è¡Œè¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
   */
  async initialize(): Promise<void> {
    console.log('ğŸ”„ DatabaseMigrationManageråˆå§‹åŒ–å¼€å§‹');

    try {
      // æ£€æŸ¥æ˜¯å¦éœ€è¦è¿ç§»
      const shouldMigrate = await this.migrationService.shouldMigrate();
      
      if (shouldMigrate) {
        console.log('ğŸ¯ æ£€æµ‹åˆ°éœ€è¦è¿ç§»ï¼Œå¼€å§‹è‡ªåŠ¨è¿ç§»...');
        await this.performMigration();
      } else {
        console.log('âœ… æ•°æ®åº“å·²æ˜¯æœ€æ–°çŠ¶æ€ï¼Œæ— éœ€è¿ç§»');
        this.migrationCompleted = true;
      }

      // åˆå§‹åŒ–SQLiteä»“å‚¨
      await this.sqliteChatRepository.initialize();
      await this.sqliteConfigRepository.initialize();

      console.log('âœ… DatabaseMigrationManageråˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('âŒ DatabaseMigrationManageråˆå§‹åŒ–å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * æ‰§è¡Œå®Œæ•´è¿ç§»æµç¨‹
   */
  private async performMigration(): Promise<void> {
    const result = await this.migrationService.migrateToSQLite();
    
    if (result.success) {
      this.migrationCompleted = true;
      console.log('ğŸ‰ è¿ç§»æˆåŠŸå®Œæˆï¼', {
        sessions: result.migratedSessions,
        messages: result.migratedMessages,
        configs: result.migratedConfigs,
        preferences: result.migratedPreferences,
        backup: result.backupPath
      });
    } else {
      console.error('âŒ è¿ç§»å¤±è´¥:', result.errors);
      throw new Error(`è¿ç§»å¤±è´¥: ${result.errors.join(', ')}`);
    }
  }

  /**
   * è·å–èŠå¤©ä¼šè¯ä»“å‚¨ï¼ˆæ™ºèƒ½è·¯ç”±ï¼‰
   */
  getChatSessionRepository() {
    if (this.migrationCompleted) {
      return this.sqliteChatRepository;
    } else {
      // é™çº§åˆ°åŸæœ‰å®ç°
      throw new Error('è¿ç§»æœªå®Œæˆï¼Œæ— æ³•æä¾›SQLiteä»“å‚¨');
    }
  }

  /**
   * è·å–æ¨¡å‹é…ç½®ä»“å‚¨ï¼ˆæ™ºèƒ½è·¯ç”±ï¼‰
   */
  getModelConfigRepository() {
    if (this.migrationCompleted) {
      return this.sqliteConfigRepository;
    } else {
      // é™çº§åˆ°åŸæœ‰å®ç°
      throw new Error('è¿ç§»æœªå®Œæˆï¼Œæ— æ³•æä¾›SQLiteä»“å‚¨');
    }
  }

  /**
   * è·å–æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
   */
  getDatabaseStats() {
    return this.databaseService.getStats();
  }

  /**
   * æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€
   */
  healthCheck(): boolean {
    return this.databaseService.healthCheck();
  }

  /**
   * å®‰å…¨å…³é—­æ•°æ®åº“
   */
  close(): void {
    this.databaseService.close();
  }

  /**
   * è·å–è¿ç§»çŠ¶æ€
   */
  isMigrationCompleted(): boolean {
    return this.migrationCompleted;
  }

  /**
   * æ‰‹åŠ¨è§¦å‘è¿ç§»ï¼ˆç”¨äºæµ‹è¯•æˆ–ä¿®å¤ï¼‰
   */
  async forceMigration(): Promise<void> {
    console.log('ğŸ”§ æ‰‹åŠ¨è§¦å‘è¿ç§»...');
    await this.performMigration();
  }
}